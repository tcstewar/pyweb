<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/pyweb.css"/>
    <link rel="stylesheet" href="splendor.css"/>
    <script src="js/jquery-3.5.0.min.js"></script>
    <script src="js/peerjs.min.js"></script>
    <script src="js/peerstack.js?1"></script>
    
    <script type="text/javascript">
      window.languagePluginUrl = 'pyodide/'
    </script>  
    <script src="pyodide/pyodide_dev.js"></script>
  </head>
  <body>
    <script>
        var peerstack = new PeerStack();
        peerstack.metadata.seed = Math.floor(Math.random() * Math.pow(2, 32));
        
        function redraw() {
            on_changed(peerstack.items, peerstack.metadata);
        };
        
        function on_open() {
            var url = new URL(window.location.href);
            if (url.search) {
                peerstack.connect_to(url.search.substr(1));
            } else {
                url.search = peerstack.peer.id;
                redraw();
            }
            $('#peersync').append($('<a></a>').text("invite").prop('href', url.href).prop('target', '_blank'));
        };
    
    
    
    
      function reload() {
        console.log('reload');
        $.get({url: 'splendor.py', cache:false}).then((code) => {
            pyodide.runPython(code);
            on_changed = pyodide.pyimport('on_changed');
                 
            peerstack.on('added', redraw)
                     .on('changed', redraw)
                     .on('open', on_open)
                     .init();
            redraw();
        });
      }
      languagePluginLoader.then(reload);
      
      function query(x) {
          return $(x);
      }      
      
      


    </script>
    
    <div id="toolbar">
        <a id="peersync" href="" target="_blank" disabled="true"></a>
    </div>    
    <div id="content">
        <div id="board">
            <div id="card1" class="card r facedown level1" style="top:55%; left:2.5%">
                <div class="points">2</div>
            </div>
            <div id="card2" class="card r facedown level2" style="top:35%; left:2.5%"></div>
            <div id="card3" class="card r facedown level3" style="top:15%; left:2.5%"></div>
            <div id="card4" class="card r" style="top:15%; left:22.5%">
                <div class="points">2</div>
                <div class="cost">
                    <div class="cost_r">2</div>
                    <div class="cost_g">1</div>
                    <div class="cost_b">3</div>
                </div>
            </div>
            <div id="card5" class="card g" style="top:15%; left:42.5%">
                <div class="points">1</div>
                <div class="cost">
                    <div class="cost_k">7</div>
                    <div class="cost_w">2</div>
                </div>
            </div>
            <div id="card6" class="card b" style="top:15%; left:62.5%">
                <div class="points">5</div>
                <div class="cost">
                    <div class="cost_b">2</div>
                    <div class="cost_k">1</div>
                    <div class="cost_w">3</div>
                    <div class="cost_g">1</div>
                </div>
            </div>
            <div id="card7" class="card w" style="top:15%; left:82.5%">
                <div class="points">3</div>
            </div>
            <div id="card8" class="card k" style="top:35%; left:22.5%">
                <div class="points">1</div>            
            </div>
            <div id="card9" class="card r" style="top:35%; left:42.5%"></div>
            <div id="card10" class="card g" style="top:35%; left:62.5%"></div>
            <div id="card11" class="card b" style="top:35%; left:82.5%"></div>
            <div id="card12" class="card w" style="top:55%; left:22.5%"></div>
            <div id="card13" class="card k" style="top:55%; left:42.5%"></div>
            <div id="card14" class="card r" style="top:55%; left:62.5%"></div>
            <div id="card15" class="card g" style="top:55%; left:82.5%"></div>
        </div>
        <div id="board_text"></div>
        <div id="actions"></div>
        <button id="btn_undo" type="button" onclick='peerstack.undo();'>Undo</button>
    </div>
  </body>
</html>
